<template>
  <VChip
    v-bind="$attrs"
    :size="props.size"
    :class="props.class"
    :color="status.color"
    variant="flat"
    data-test-id="proposal-status-chip"
  >
    <slot>
      {{ $t(`proposals.status.${status.name}`) }}
    </slot>
  </VChip>
  <template v-if="variantIs(props.status, 'Completed')">
    <VTooltip
      v-model="openDetails"
      location="bottom"
      :open-on-hover="false"
      :open-on-click="true"
      @click:outside="openDetails = false"
    >
      <template #activator="{ props: infoProps }">
        <VBtn :icon="mdiInformationOutline" size="x-small" v-bind="infoProps" />
      </template>
      {{ $t('proposals.processing_completed_at', { dt: props.status.Completed.completed_at }) }}
    </VTooltip>
  </template>
  <template v-else-if="variantIs(props.status, 'Failed')">
    <VTooltip
      v-model="openDetails"
      location="bottom"
      :open-on-hover="false"
      :open-on-click="true"
      @click:outside="openDetails = false"
    >
      <template #activator="{ props: infoProps }">
        <VBtn :icon="mdiInformationOutline" size="x-small" v-bind="infoProps" />
      </template>
      {{
        props.status.Failed.reason?.[0]
          ? props.status.Failed.reason[0]
          : $t('proposals.no_failed_reason')
      }}
    </VTooltip>
  </template>
  <template v-else-if="variantIs(props.status, 'Cancelled')">
    <VTooltip
      v-model="openDetails"
      location="bottom"
      :open-on-hover="false"
      :open-on-click="true"
      @click:outside="openDetails = false"
    >
      <template #activator="{ props: infoProps }">
        <VBtn :icon="mdiInformationOutline" size="x-small" v-bind="infoProps" />
      </template>
      {{
        props.status.Cancelled.reason?.[0]
          ? props.status.Cancelled.reason[0]
          : $t('proposals.no_cancelled_reason')
      }}
    </VTooltip>
  </template>
  <template v-else-if="variantIs(props.status, 'Processing')">
    <VTooltip
      v-model="openDetails"
      location="bottom"
      :open-on-hover="false"
      :open-on-click="true"
      @click:outside="openDetails = false"
    >
      <template #activator="{ props: infoProps }">
        <VBtn :icon="mdiInformationOutline" size="x-small" v-bind="infoProps" />
      </template>
      {{ $t('proposals.processing_started_at', { dt: props.status.Processing.started_at }) }}
    </VTooltip>
  </template>
  <template v-else-if="variantIs(props.status, 'Scheduled')">
    <VTooltip
      v-model="openDetails"
      location="bottom"
      :open-on-hover="false"
      :open-on-click="true"
      @click:outside="openDetails = false"
    >
      <template #activator="{ props: infoProps }">
        <VBtn :icon="mdiInformationOutline" size="x-small" v-bind="infoProps" />
      </template>
      {{ $t('proposals.processing_scheduled_at', { dt: props.status.Scheduled.scheduled_at }) }}
    </VTooltip>
  </template>
</template>

<script setup lang="ts">
import { mdiInformationOutline } from '@mdi/js';
import { computed, ref } from 'vue';
import { ProposalStatus } from '~/generated/wallet/wallet.did';
import { variantIs } from '~/utils/helper.utils';

const props = withDefaults(
  defineProps<{
    status: ProposalStatus;
    class?: string;
    size?: string | number;
  }>(),
  {
    class: 'text-lowercase',
    size: 'default',
  },
);

let openDetails = ref(false);

const status = computed(() => {
  if (variantIs(props.status, 'Created')) {
    return { name: 'created', color: 'warning' };
  }

  if (variantIs(props.status, 'Cancelled')) {
    return { name: 'cancelled', color: 'error' };
  }

  if (variantIs(props.status, 'Adopted')) {
    return { name: 'adopted', color: 'info' };
  }

  if (variantIs(props.status, 'Rejected')) {
    return { name: 'rejected', color: 'error' };
  }

  if (variantIs(props.status, 'Completed')) {
    return { name: 'completed', color: 'success' };
  }

  if (variantIs(props.status, 'Failed')) {
    return { name: 'failed', color: 'error' };
  }

  if (variantIs(props.status, 'Processing')) {
    return { name: 'processing', color: 'info' };
  }

  if (variantIs(props.status, 'Scheduled')) {
    return { name: 'scheduled', color: 'info' };
  }

  return { name: 'unknown', color: 'default' };
});
</script>
